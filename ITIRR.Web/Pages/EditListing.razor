@page "/edit-listing/{ListingId:guid}"
@layout ITIRR.Web.Shared.DashboardLayout
@attribute [Authorize]
@inject NavigationManager Navigation
@inject CustomAuthStateProvider AuthStateProvider
@inject HttpClient Http
@using Microsoft.AspNetCore.Authorization
@using ITIRR.Web.Auth
@using System.Net.Http.Json
@using System.Text.Json

<div class="container-fluid">

    <!-- BREADCRUMB -->
    <div class="row">
        <div class="col-md-12">
            <nav style="--bs-breadcrumb-divider: '>';" aria-label="breadcrumb">
                <ol class="breadcrumb custom-breadcrumb">
                    <li class="breadcrumb-item"><a href="/partner-home">Dashboard</a></li>
                    <li class="breadcrumb-item"><a href="/my-listings">All Listed Vehicles</a></li>
                    <li class="breadcrumb-item active" aria-current="page">
                        @(string.IsNullOrEmpty(form.LicencePlateNumber) ? "Edit Listing" : form.LicencePlateNumber)
                    </li>
                </ol>
            </nav>
        </div>
    </div>

    <!-- HEADING -->
    <div class="row">
        <div class="col-md-12">
            <div class="agency-header">
                <h1>@(string.IsNullOrEmpty(form.LicencePlateNumber) ? "Edit Vehicle Listing" : form.LicencePlateNumber)</h1>
                <p>Experience refined comfort and executive style, anywhere you go.</p>
            </div>
        </div>
    </div>

    @if (isPageLoading)
    {
        <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status"></div>
            <p class="mt-3">Loading listing...</p>
        </div>
    }
    else
    {
        @if (!string.IsNullOrEmpty(errorMessage))
        {
            <div class="alert alert-danger alert-dismissible">
                <i class="fa-solid fa-circle-exclamation me-2"></i>@errorMessage
                <button class="btn-close" @onclick="@(() => errorMessage = string.Empty)"></button>
            </div>
        }
        @if (!string.IsNullOrEmpty(successMessage))
        {
            <div class="alert alert-success alert-dismissible">
                <i class="fa-solid fa-circle-check me-2"></i>@successMessage
                <button class="btn-close" @onclick="@(() => successMessage = string.Empty)"></button>
            </div>
        }

        <div class="row">

            <!-- ========== 1. LOCATION DETAIL ========== -->
            <div class="col-md-12 custom-top col-lg-12 col-12">
                <div class="dropdown-container">
                    <button class="dropdown-btn btn-color" type="button"
                            @onclick="@(() => ToggleSection("location"))">
                        Location Detail
                        <i class="bi @(openSection == "location" ? "bi-chevron-up" : "bi-chevron-down")"></i>
                    </button>
                    <div class="dropdown-content" style="@(openSection == "location" ? "display:block;" : "display:none;")">
                        <div class="container-fluid">
                            <div class="row g-2">
                                <div class="col-md-6">
                                    <label class="form-label lable-css">Country</label>
                                    <select class="no-border-select-input no-border-select"
                                            value="@form.CountryId"
                                            @onchange="OnCountryChanged">
                                        <option value="">-- Select Country --</option>
                                        @foreach (var c in countries)
                                        {
                                            <option value="@c.Id">@c.Name</option>
                                        }
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label lable-css">State</label>
                                    <input type="text" placeholder="Enter State"
                                           class="form-control no-border-select-input no-border-select-input-1"
                                           @bind="form.State" />
                                </div>
                                <div class="col-md-6 custom-top">
                                    <label class="form-label lable-css">City</label>
                                    <select class="no-border-select-input no-border-select"
                                            value="@form.CityId"
                                            @onchange="e => form.CityId = ParseGuid(e.Value?.ToString())">
                                        <option value="">-- Select City --</option>
                                        @foreach (var c in cities)
                                        {
                                            <option value="@c.Id">@c.Name</option>
                                        }
                                    </select>
                                </div>
                                <div class="col-md-6 custom-top">
                                    <label class="form-label lable-css">Zip Code</label>
                                    <input type="text" placeholder="Zip Code"
                                           class="form-control no-border-select-input no-border-select-input-1"
                                           @bind="form.ZipCode" />
                                </div>
                                <div class="col-md-12 custom-top">
                                    <label class="form-label lable-css">Street Address</label>
                                    <input type="text" placeholder="Enter Street/Road Address"
                                           class="form-control no-border-select-input no-border-select-input-1"
                                           @bind="form.StreetAddress" />
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ========== 2. VIN & LICENCE PLATE ========== -->
            <div class="col-md-12 custom-top col-lg-12 col-12">
                <div class="dropdown-container">
                    <button class="dropdown-btn btn-color" type="button"
                            @onclick="@(() => ToggleSection("vin"))">
                        VIN & Licence Number Plate
                        <i class="bi @(openSection == "vin" ? "bi-chevron-up" : "bi-chevron-down")"></i>
                    </button>
                    <div class="dropdown-content" style="@(openSection == "vin" ? "display:block;" : "display:none;")">
                        <div class="container-fluid">
                            <div class="row g-2">
                                <div class="col-md-6 col-12 custom-top">
                                    <label class="form-label lable-css">Enter your VIN</label>
                                    <input type="text" placeholder="Enter your 17 Digit VIN"
                                           class="form-control no-border-select-input no-border-select-input-1"
                                           @bind="form.VIN"
                                           disabled="@form.IsOlderThan1981" />
                                </div>
                                <div class="col-md-6 col-12 custom-top">
                                    <label class="form-label lable-css">Licence Plate Number</label>
                                    <input type="text" placeholder="Licence Plate Number"
                                           class="form-control no-border-select-input no-border-select-input-1"
                                           @bind="form.LicencePlateNumber" />
                                </div>
                                <div class="custom-checkbox custom-top">
                                    <input type="checkbox" id="olderThan1981"
                                           @bind="form.IsOlderThan1981" />
                                    <label for="olderThan1981" class="lable-css">
                                        My car is older than 1981
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ========== 3. ODOMETER & TRANSMISSION ========== -->
            <div class="col-md-12 custom-top col-lg-12 col-12">
                <div class="dropdown-container">
                    <button class="dropdown-btn btn-color" type="button"
                            @onclick="@(() => ToggleSection("odometer"))">
                        Odometer & Transmission
                        <i class="bi @(openSection == "odometer" ? "bi-chevron-up" : "bi-chevron-down")"></i>
                    </button>
                    <div class="dropdown-content" style="@(openSection == "odometer" ? "display:block;" : "display:none;")">
                        <div class="container-fluid">
                            <div class="row g-2">
                                <div class="col-md-12 col-12">
                                    <label class="form-label lable-css">What is your car's odometer reading?</label>
                                    <select class="no-border-select-input no-border-select"
                                            @bind="form.OdometerReading">
                                        <option value="">-- Select Odometer Reading --</option>
                                        <option value="Under 10,000 km">Under 10,000 km</option>
                                        <option value="10,000-50,000 km">10,000 – 50,000 km</option>
                                        <option value="50,000-100,000 km">50,000 – 100,000 km</option>
                                        <option value="100,000-150,000 km">100,000 – 150,000 km</option>
                                        <option value="150,000-200,000 km">150,000 – 200,000 km</option>
                                        <option value="200,000+ km">200,000+ km</option>
                                    </select>
                                </div>
                                <label class="lable-css custom-top">Transmission</label>
                                <div class="custom-radio-row">
                                    <div class="custom-radio">
                                        <input type="radio" id="automatic" name="transmission"
                                               checked="@(form.Transmission == "Automatic")"
                                               @onchange="@(() => form.Transmission = "Automatic")" />
                                        <label for="automatic">Automatic</label>
                                    </div>
                                    <div class="custom-radio">
                                        <input type="radio" id="manual" name="transmission"
                                               checked="@(form.Transmission == "Manual")"
                                               @onchange="@(() => form.Transmission = "Manual")" />
                                        <label for="manual">Manual</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ========== 4. CAR FEATURES ========== -->
            <div class="col-md-12 custom-top col-lg-12 col-12">
                <div class="dropdown-container">
                    <button class="dropdown-btn btn-color" type="button"
                            @onclick="@(() => ToggleSection("features"))">
                        Car Features
                        <i class="bi @(openSection == "features" ? "bi-chevron-up" : "bi-chevron-down")"></i>
                    </button>
                    <div class="dropdown-content" style="@(openSection == "features" ? "display:block;" : "display:none;")">
                        <div class="container-fluid">
                            <div class="row g-2">
                                <div class="col-md-4">
                                    <div class="custom-checkbox custom-top">
                                        <input type="checkbox" id="f0"
                                               checked="@form.Features.Contains("Adaptive Cruise Control")"
                                               @onchange="@(e => ToggleFeature("Adaptive Cruise Control", (bool)e.Value!))" />
                                        <label for="f0" class="lable-css">Adaptive Cruise Control</label>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="custom-checkbox custom-top">
                                        <input type="checkbox" id="f1"
                                               checked="@form.Features.Contains("Lane Keeping Assist")"
                                               @onchange="@(e => ToggleFeature("Lane Keeping Assist", (bool)e.Value!))" />
                                        <label for="f1" class="lable-css">Lane Keeping Assist</label>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="custom-checkbox custom-top">
                                        <input type="checkbox" id="f2"
                                               checked="@form.Features.Contains("Blind Spot Monitoring")"
                                               @onchange="@(e => ToggleFeature("Blind Spot Monitoring", (bool)e.Value!))" />
                                        <label for="f2" class="lable-css">Blind Spot Monitoring</label>
                                    </div>
                                </div>
                            </div>
                            <div class="row g-2 custom-top">
                                <div class="col-md-4">
                                    <div class="custom-checkbox custom-top">
                                        <input type="checkbox" id="f3"
                                               checked="@form.Features.Contains("Automatic Emergency Braking")"
                                               @onchange="@(e => ToggleFeature("Automatic Emergency Braking", (bool)e.Value!))" />
                                        <label for="f3" class="lable-css">Automatic Emergency Braking</label>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="custom-checkbox custom-top">
                                        <input type="checkbox" id="f4"
                                               checked="@form.Features.Contains("Parking Assistance")"
                                               @onchange="@(e => ToggleFeature("Parking Assistance", (bool)e.Value!))" />
                                        <label for="f4" class="lable-css">Parking Assistance</label>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="custom-checkbox custom-top">
                                        <input type="checkbox" id="f5"
                                               checked="@form.Features.Contains("Traffic Sign Recognition")"
                                               @onchange="@(e => ToggleFeature("Traffic Sign Recognition", (bool)e.Value!))" />
                                        <label for="f5" class="lable-css">Traffic Sign Recognition</label>
                                    </div>
                                </div>
                            </div>
                            <div class="row g-2 custom-top">
                                <div class="col-md-4">
                                    <div class="custom-checkbox custom-top">
                                        <input type="checkbox" id="f6"
                                               checked="@form.Features.Contains("Collision Avoidance System")"
                                               @onchange="@(e => ToggleFeature("Collision Avoidance System", (bool)e.Value!))" />
                                        <label for="f6" class="lable-css">Collision Avoidance System</label>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="custom-checkbox custom-top">
                                        <input type="checkbox" id="f7"
                                               checked="@form.Features.Contains("Rear Cross Traffic Alert")"
                                               @onchange="@(e => ToggleFeature("Rear Cross Traffic Alert", (bool)e.Value!))" />
                                        <label for="f7" class="lable-css">Rear Cross Traffic Alert</label>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="custom-checkbox custom-top">
                                        <input type="checkbox" id="f8"
                                               checked="@form.Features.Contains("Adaptive Headlights")"
                                               @onchange="@(e => ToggleFeature("Adaptive Headlights", (bool)e.Value!))" />
                                        <label for="f8" class="lable-css">Adaptive Headlights</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ========== 5. CAR HISTORY ========== -->
            <div class="col-md-12 custom-top col-lg-12 col-12">
                <div class="dropdown-container">
                    <button class="dropdown-btn btn-color" type="button"
                            @onclick="@(() => ToggleSection("history"))">
                        Car History
                        <i class="bi @(openSection == "history" ? "bi-chevron-up" : "bi-chevron-down")"></i>
                    </button>
                    <div class="dropdown-content" style="@(openSection == "history" ? "display:block;" : "display:none;")">
                        <div class="container-fluid">
                            <div class="row g-2">
                                <div class="col-12">
                                    <label class="lable-css custom-top">
                                        I certify I paid applicable sales or related taxes on the purchase of this vehicle &nbsp;
                                        <i class="fa-solid fa-circle-info"></i>
                                    </label>
                                    <div class="custom-radio-row">
                                        <div class="custom-radio">
                                            <input type="radio" id="taxYes" name="taxCert"
                                                   checked="@(form.TaxCertified == true)"
                                                   @onchange="@(() => form.TaxCertified = true)" />
                                            <label for="taxYes">Yes</label>
                                        </div>
                                        <div class="custom-radio">
                                            <input type="radio" id="taxNo" name="taxCert"
                                                   checked="@(form.TaxCertified == false)"
                                                   @onchange="@(() => form.TaxCertified = false)" />
                                            <label for="taxNo">No</label>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-12">
                                    <label class="lable-css custom-top">
                                        Branded or Salvage Title &nbsp;
                                        <i class="fa-solid fa-circle-info"></i>
                                    </label>
                                    <div class="custom-radio-row">
                                        <div class="custom-radio">
                                            <input type="radio" id="salvageYes" name="salvage"
                                                   checked="@(form.HasSalvageTitle == true)"
                                                   @onchange="@(() => form.HasSalvageTitle = true)" />
                                            <label for="salvageYes">Yes</label>
                                        </div>
                                        <div class="custom-radio">
                                            <input type="radio" id="salvageNo" name="salvage"
                                                   checked="@(form.HasSalvageTitle == false)"
                                                   @onchange="@(() => form.HasSalvageTitle = false)" />
                                            <label for="salvageNo">No</label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ========== 6. YOUR GOALS ========== -->
            <div class="col-md-12 custom-top col-lg-12 col-12">
                <div class="dropdown-container">
                    <button class="dropdown-btn btn-color" type="button"
                            @onclick="@(() => ToggleSection("goals"))">
                        Your Goals
                        <i class="bi @(openSection == "goals" ? "bi-chevron-up" : "bi-chevron-down")"></i>
                    </button>
                    <div class="dropdown-content" style="@(openSection == "goals" ? "display:block;" : "display:none;")">
                        <div class="container-fluid">
                            <div class="row g-2">
                                <div class="col-md-12">
                                    <label class="form-label lable-css">
                                        What is your primary financial goal for sharing this car on ITIRR
                                    </label>
                                    <select class="no-border-select-input no-border-select"
                                            @bind="form.PrimaryGoal">
                                        <option value="">-- Select option --</option>
                                        <option value="Only a few times a year">Only a few times a year</option>
                                        <option value="A few times each season">A few times each season</option>
                                        <option value="Monthly or more">Monthly or more</option>
                                        <option value="Weekly or throughout the season">Weekly or throughout the season</option>
                                    </select>
                                </div>
                                <div class="col-md-12 custom-top">
                                    <label class="form-label lable-css">
                                        How often do you or your family currently use this car?
                                    </label>
                                    <select class="no-border-select-input no-border-select"
                                            @bind="form.UsageFrequency">
                                        <option value="">-- Select option --</option>
                                        <option value="Only a few times a year">Only a few times a year</option>
                                        <option value="A few times each season">A few times each season</option>
                                        <option value="Monthly or more">Monthly or more</option>
                                        <option value="Weekly or throughout the season">Weekly or throughout the season</option>
                                    </select>
                                </div>
                                <div class="col-md-12 custom-top">
                                    <label class="form-label lable-css">
                                        How often do you want to share your car?
                                    </label>
                                    <select class="no-border-select-input no-border-select"
                                            @bind="form.ShareFrequency">
                                        <option value="">-- Select option --</option>
                                        <option value="Limited availability; a few times a year">Limited availability; a few times a year</option>
                                        <option value="A few times each month or season">A few times each month or season</option>
                                        <option value="Consistent sharing when not using it">Consistent sharing when not using it</option>
                                        <option value="Maximum availability for bookings">Maximum availability for bookings</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ========== 7. ADVANCE NOTICE & TRIP DURATION ========== -->
            <div class="col-md-12 custom-top col-lg-12 col-12">
                <div class="dropdown-container">
                    <button class="dropdown-btn btn-color" type="button"
                            @onclick="@(() => ToggleSection("notice"))">
                        Advance Notice & Trip Duration
                        <i class="bi @(openSection == "notice" ? "bi-chevron-up" : "bi-chevron-down")"></i>
                    </button>
                    <div class="dropdown-content" style="@(openSection == "notice" ? "display:block;" : "display:none;")">
                        <div class="container-fluid">
                            <div class="row g-2">
                                <div class="col-md-12">
                                    <h3 class="head-account custom-top">Advance Notice</h3>
                                    <label class="form-label custom-top lable-css">
                                        How much advance notice do you need before a trip starts? &nbsp;
                                        <i class="fa-solid fa-circle-info"></i>
                                    </label>
                                    <select class="no-border-select-input no-border-select"
                                            @bind="form.AdvanceNotice">
                                        <option value="">-- Select option --</option>
                                        <option value="Same Day">Same Day Notice</option>
                                        <option value="24 Hours">24 Hours Notice</option>
                                        <option value="48 Hours">48 Hours Notice</option>
                                        <option value="1 Week">1 Week Notice</option>
                                    </select>
                                </div>
                                <h3 class="head-account custom-top-2">Trip Duration</h3>
                                <div class="col-md-6 custom-top">
                                    <label class="form-label lable-css">
                                        Trip Duration &nbsp;<i class="fa-solid fa-circle-info"></i>
                                    </label>
                                    <select class="no-border-select-input no-border-select"
                                            @bind="form.MinTripDuration">
                                        <option value="">-- Select option --</option>
                                        <option value="2-Day Minimum">2-Day Minimum</option>
                                        <option value="1-Week">1-Week</option>
                                    </select>
                                </div>
                                <div class="col-md-6 custom-top">
                                    <label class="form-label lable-css">
                                        Maximum Trip Duration &nbsp;<i class="fa-solid fa-circle-info"></i>
                                    </label>
                                    <select class="no-border-select-input no-border-select"
                                            @bind="form.MaxTripDuration">
                                        <option value="">-- Select option --</option>
                                        <option value="1-Month Maximum">1-Month Maximum</option>
                                        <option value="No Maximum">No Maximum - Flexible</option>
                                    </select>
                                </div>
                                <div class="col-md-12">
                                    <div class="custom-checkbox custom-top">
                                        <input type="checkbox" id="minTwoDay"
                                               @bind="form.MinTwoDayWeekend" />
                                        <label for="minTwoDay" class="lable-css">
                                            Require a 2-Day minimum for trips that start Friday, Saturday and Sunday.
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ========== 8. PCO LICENCE ========== -->
            <div class="col-md-12 custom-top col-lg-12 col-12">
                <div class="dropdown-container">
                    <button class="dropdown-btn btn-color" type="button"
                            @onclick="@(() => ToggleSection("pco"))">
                        PCO Licence
                        <i class="bi @(openSection == "pco" ? "bi-chevron-up" : "bi-chevron-down")"></i>
                    </button>
                    <div class="dropdown-content" style="@(openSection == "pco" ? "display:block;" : "display:none;")">
                        <div class="container-fluid">
                            <div class="row g-2">
                                <div class="col-md-6 col-12 custom-top">
                                    <label class="form-label lable-css">Vehicle Make & Model</label>
                                    <input type="text" placeholder="Vehicle Make & Model"
                                           class="form-control no-border-select-input no-border-select-input-1"
                                           @bind="form.VehicleMakeModel" />
                                </div>
                                <div class="col-md-6 col-12 custom-top">
                                    <label class="form-label lable-css">Plate Number</label>
                                    <input type="text" placeholder="Plate Number"
                                           class="form-control no-border-select-input no-border-select-input-1"
                                           @bind="form.PlateNumber" />
                                </div>
                                <div class="col-md-4 col-12 custom-top">
                                    <label class="form-label lable-css">Vehicle Color</label>
                                    <input type="text" placeholder="Vehicle Color"
                                           class="form-control no-border-select-input no-border-select-input-1"
                                           @bind="form.VehicleColor" />
                                </div>
                                <div class="col-md-4 col-12 custom-top">
                                    <label class="form-label lable-css">Year of Manufacture</label>
                                    <input type="text" placeholder="Year of Manufacture"
                                           class="form-control no-border-select-input no-border-select-input-1"
                                           @bind="form.YearOfManufacture" />
                                </div>
                                <div class="col-md-4 col-12 custom-top">
                                    <label class="form-label lable-css">PHV Licence Number</label>
                                    <input type="text" placeholder="PHV Licence Number"
                                           class="form-control no-border-select-input no-border-select-input-1"
                                           @bind="form.PHVLicenceNumber" />
                                </div>
                                <div class="col-md-6 col-12 custom-top">
                                    <label class="form-label lable-css">PHV Licence Expiry Date</label>
                                    <input type="text" placeholder="e.g. 2026-12-31"
                                           class="form-control no-border-select-input no-border-select-input-1"
                                           @bind="form.PHVLicenceExpiryDate" />
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ========== BOTTOM BUTTONS ========== -->
            <div class="col-md-12 custom-top">
                <div class="container-fluid">
                    <div class="row row-position">
                        <div class="col-md-6"></div>
                        <div class="col-md-6 coloumn-position">
                            <a href="/my-listings">
                                <button class="btn button-1" type="button">Cancel</button>
                            </a>
                            <button class="btn button-2" type="button"
                                    @onclick="SaveDraft"
                                    disabled="@isSaving">
                                @if (isSaving && !isSubmitting)
                                {
                                    <i class="fa-solid fa-spinner fa-spin me-1"></i>
                                    <span>Saving...</span>
                                }
                                else
                                {
                                    <span>Save Only</span>
                                }
                            </button>
                            <button class="btn button-3" type="button"
                                    @onclick="SaveAndSubmit"
                                    disabled="@isSaving">
                                @if (isSaving && isSubmitting)
                                {
                                    <i class="fa-solid fa-spinner fa-spin me-1"></i>
                                    <span>Submitting...</span>
                                }
                                else
                                {
                                    <span>Save & Submit</span>
                                }
                            </button>
                        </div>
                    </div>
                </div>
            </div>

        </div>

        <!-- end row -->
    }
</div>

@code {
    [Parameter] public Guid ListingId { get; set; }

    private bool isPageLoading = true;
    private bool isSaving = false;
    private bool isSubmitting = false;
    private string openSection = "location";
    private string errorMessage = string.Empty;
    private string successMessage = string.Empty;

    private EditForm form = new();
    private List<CountryDto> countries = new();
    private List<CityDto> cities = new();

    private void ToggleSection(string section)
    {
        openSection = openSection == section ? string.Empty : section;
    }

    protected override async Task OnInitializedAsync()
    {
        var token = await AuthStateProvider.GetAccessTokenAsync();
        if (!string.IsNullOrEmpty(token))
            Http.DefaultRequestHeaders.Authorization =
                new System.Net.Http.Headers.AuthenticationHeaderValue("Bearer", token);

        await LoadCountries();
        await LoadListingData();
        isPageLoading = false;
    }

    private async Task LoadCountries()
    {
        try
        {
            var result = await Http.GetFromJsonAsync<ApiResp<List<CountryDto>>>(
                "api/v1/countries",
                new JsonSerializerOptions { PropertyNameCaseInsensitive = true });
            if (result?.Data != null) countries = result.Data;
        }
        catch { }
    }

    private async Task LoadCities()
    {
        cities.Clear();
        if (form.CountryId == null) return;
        try
        {
            var result = await Http.GetFromJsonAsync<ApiResp<List<CityDto>>>(
                $"api/v1/countries/{form.CountryId}/cities",
                new JsonSerializerOptions { PropertyNameCaseInsensitive = true });
            if (result?.Data != null) cities = result.Data;
        }
        catch { }
    }

    private async Task OnCountryChanged(ChangeEventArgs e)
    {
        form.CountryId = ParseGuid(e.Value?.ToString());
        form.CityId = null;
        cities.Clear();
        await LoadCities();
    }

    private async Task LoadListingData()
    {
        try
        {
            var response = await Http.GetAsync($"api/v1/vehicle-listing/{ListingId}/edit-data");
            var json = await response.Content.ReadAsStringAsync();
            var result = JsonSerializer.Deserialize<ApiResp<ListingFullData>>(json,
                new JsonSerializerOptions { PropertyNameCaseInsensitive = true });

            if (result?.Success == true && result.Data != null)
            {
                var d = result.Data;
                form.CountryId = d.CountryId;
                form.State = d.State ?? string.Empty;
                form.CityId = d.CityId;
                form.ZipCode = d.ZipCode ?? string.Empty;
                form.StreetAddress = d.StreetAddress ?? string.Empty;
                form.VIN = d.VIN ?? string.Empty;
                form.IsOlderThan1981 = d.IsOlderThan1981;
                form.LicencePlateNumber = d.LicencePlateNumber ?? string.Empty;
                form.OdometerReading = d.OdometerReading ?? string.Empty;
                form.Transmission = d.Transmission ?? string.Empty;
                form.TaxCertified = d.TaxCertified ?? false;
                form.HasSalvageTitle = d.HasSalvageTitle ?? false;
                form.PrimaryGoal = d.PrimaryGoal ?? string.Empty;
                form.UsageFrequency = d.UsageFrequency ?? string.Empty;
                form.ShareFrequency = d.ShareFrequency ?? string.Empty;
                form.AdvanceNotice = d.AdvanceNotice ?? string.Empty;
                form.MinTripDuration = d.MinTripDuration ?? string.Empty;
                form.MaxTripDuration = d.MaxTripDuration ?? string.Empty;
                form.MinTwoDayWeekend = d.MinTwoDayWeekend;
                form.VehicleMakeModel = d.VehicleMakeModel ?? string.Empty;
                form.PlateNumber = d.PlateNumber ?? string.Empty;
                form.VehicleColor = d.VehicleColor ?? string.Empty;
                form.YearOfManufacture = d.YearOfManufacture ?? string.Empty;
                form.PHVLicenceNumber = d.PHVLicenceNumber ?? string.Empty;
                form.PHVLicenceExpiryDate = d.PHVLicenceExpiryDate ?? string.Empty;

                if (!string.IsNullOrEmpty(d.Features))
                {
                    try { form.Features = JsonSerializer.Deserialize<List<string>>(d.Features) ?? new(); }
                    catch { }
                }

                if (form.CountryId != null) await LoadCities();
            }
            else errorMessage = "Failed to load listing data.";
        }
        catch (Exception ex) { errorMessage = ex.Message; }
    }

    private async Task SaveDraft()
    {
        isSaving = true;
        isSubmitting = false;
        await SubmitForm(submit: false);
        isSaving = false;
    }

    private async Task SaveAndSubmit()
    {
        isSaving = true;
        isSubmitting = true;
        await SubmitForm(submit: true);
        isSaving = false;
    }

    private async Task SubmitForm(bool submit)
    {
        errorMessage = successMessage = string.Empty;
        try
        {
            var request = new
            {
                ListingId = ListingId,
                form.CountryId,
                form.State,
                form.CityId,
                form.ZipCode,
                form.StreetAddress,
                form.VIN,
                form.IsOlderThan1981,
                form.LicencePlateNumber,
                form.OdometerReading,
                form.Transmission,
                form.Features,
                form.TaxCertified,
                form.HasSalvageTitle,
                form.PrimaryGoal,
                form.UsageFrequency,
                form.ShareFrequency,
                form.AdvanceNotice,
                form.MinTripDuration,
                form.MaxTripDuration,
                form.MinTwoDayWeekend,
                form.VehicleMakeModel,
                form.PlateNumber,
                form.VehicleColor,
                form.YearOfManufacture,
                form.PHVLicenceNumber,
                form.PHVLicenceExpiryDate
            };

            var endpoint = submit
                ? $"api/v1/vehicle-listing/{ListingId}/save-and-submit"
                : $"api/v1/vehicle-listing/{ListingId}/save";

            var response = await Http.PutAsJsonAsync(endpoint, request);
            var json = await response.Content.ReadAsStringAsync();
            var result = JsonSerializer.Deserialize<ApiResp<object>>(json,
                new JsonSerializerOptions { PropertyNameCaseInsensitive = true });

            if (result?.Success == true)
            {
                successMessage = submit
                    ? "Listing submitted for review successfully!"
                    : "Listing saved as draft successfully!";

                if (submit)
                {
                    await Task.Delay(1500);
                    Navigation.NavigateTo("/my-listings");
                }
            }
            else errorMessage = result?.Message ?? "Failed to save.";
        }
        catch (Exception ex) { errorMessage = ex.Message; }
    }

    private void ToggleFeature(string feature, bool add)
    {
        if (add) { if (!form.Features.Contains(feature)) form.Features.Add(feature); }
        else form.Features.Remove(feature);
    }

    private static Guid? ParseGuid(string? value)
    {
        if (string.IsNullOrEmpty(value)) return null;
        return Guid.TryParse(value, out var g) ? g : null;
    }

    // ── MODELS ──
    class EditForm
    {
        public Guid? CountryId { get; set; }
        public string State { get; set; } = string.Empty;
        public Guid? CityId { get; set; }
        public string ZipCode { get; set; } = string.Empty;
        public string StreetAddress { get; set; } = string.Empty;
        public string VIN { get; set; } = string.Empty;
        public bool IsOlderThan1981 { get; set; }
        public string LicencePlateNumber { get; set; } = string.Empty;
        public string OdometerReading { get; set; } = string.Empty;
        public string Transmission { get; set; } = string.Empty;
        public List<string> Features { get; set; } = new();
        public bool TaxCertified { get; set; }
        public bool HasSalvageTitle { get; set; }
        public string PrimaryGoal { get; set; } = string.Empty;
        public string UsageFrequency { get; set; } = string.Empty;
        public string ShareFrequency { get; set; } = string.Empty;
        public string AdvanceNotice { get; set; } = string.Empty;
        public string MinTripDuration { get; set; } = string.Empty;
        public string MaxTripDuration { get; set; } = string.Empty;
        public bool MinTwoDayWeekend { get; set; }
        public string VehicleMakeModel { get; set; } = string.Empty;
        public string PlateNumber { get; set; } = string.Empty;
        public string VehicleColor { get; set; } = string.Empty;
        public string YearOfManufacture { get; set; } = string.Empty;
        public string PHVLicenceNumber { get; set; } = string.Empty;
        public string PHVLicenceExpiryDate { get; set; } = string.Empty;
    }

    class ApiResp<T>
    {
        public bool Success { get; set; }
        public string Message { get; set; } = string.Empty;
        public T? Data { get; set; }
    }

    class CountryDto { public Guid Id { get; set; } public string Name { get; set; } = string.Empty; }
    class CityDto { public Guid Id { get; set; } public string Name { get; set; } = string.Empty; }

    class ListingFullData
    {
        public Guid ListingId { get; set; }
        public string VehicleType { get; set; } = string.Empty;
        public string Status { get; set; } = string.Empty;
        public int CurrentStep { get; set; }
        public Guid? CountryId { get; set; }
        public string? State { get; set; }
        public Guid? CityId { get; set; }
        public string? ZipCode { get; set; }
        public string? StreetAddress { get; set; }
        public string? VIN { get; set; }
        public bool IsOlderThan1981 { get; set; }
        public string? LicencePlateNumber { get; set; }
        public string? OdometerReading { get; set; }
        public string? Transmission { get; set; }
        public string? Features { get; set; }
        public bool? TaxCertified { get; set; }
        public bool? HasSalvageTitle { get; set; }
        public string? PrimaryGoal { get; set; }
        public string? UsageFrequency { get; set; }
        public string? ShareFrequency { get; set; }
        public string? AdvanceNotice { get; set; }
        public string? MinTripDuration { get; set; }
        public string? MaxTripDuration { get; set; }
        public bool MinTwoDayWeekend { get; set; }
        public string? VehicleMakeModel { get; set; }
        public string? PlateNumber { get; set; }
        public string? VehicleColor { get; set; }
        public string? YearOfManufacture { get; set; }
        public string? PHVLicenceNumber { get; set; }
        public string? PHVLicenceExpiryDate { get; set; }
    }
}