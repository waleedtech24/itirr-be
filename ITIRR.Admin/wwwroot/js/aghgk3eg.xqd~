/* ============================================
   ITIRR Admin - Global JavaScript
   Core functions used across all pages
   ============================================ */

// Global namespace to avoid conflicts
const ITIRRAdmin = {
    // Configuration
    config: {
        apiBaseUrl: '/api',
        dateFormat: 'DD/MM/YYYY',
        timeFormat: 'HH:mm',
        pageSize: 10
    },

    // Initialization
    init: function() {
        this.initSidebar();
        this.initHeader();
        this.initTooltips();
        this.initFormValidation();
        console.log('ITIRR Admin initialized successfully');
    },

    // ============================================
    // SIDEBAR FUNCTIONS
    // ============================================
    initSidebar: function() {
        const sidebar = document.querySelector('.sidebar');
        const toggleBtn = document.querySelector('.sidebar-toggle');
        const mainContent = document.querySelector('.main-content');

        // Toggle sidebar
        if (toggleBtn) {
            toggleBtn.addEventListener('click', function() {
                sidebar.classList.toggle('collapsed');
                
                // Save state to localStorage
                const isCollapsed = sidebar.classList.contains('collapsed');
                localStorage.setItem('sidebarCollapsed', isCollapsed);
            });
        }

        // Load saved state
        const savedState = localStorage.getItem('sidebarCollapsed');
        if (savedState === 'true') {
            sidebar.classList.add('collapsed');
        }

        // Mobile menu toggle
        const mobileToggle = document.querySelector('.mobile-menu-toggle');
        if (mobileToggle) {
            mobileToggle.addEventListener('click', function() {
                sidebar.classList.toggle('show');
            });
        }

        // Close sidebar on mobile when clicking outside
        document.addEventListener('click', function(e) {
            if (window.innerWidth <= 768) {
                if (!sidebar.contains(e.target) && !mobileToggle.contains(e.target)) {
                    sidebar.classList.remove('show');
                }
            }
        });

        // Handle submenu toggles
        const menuItems = document.querySelectorAll('.menu-item.has-submenu');
        menuItems.forEach(item => {
            item.addEventListener('click', function(e) {
                e.preventDefault();
                
                // Don't toggle if sidebar is collapsed
                if (!sidebar.classList.contains('collapsed')) {
                    this.classList.toggle('open');
                    const submenu = this.nextElementSibling;
                    if (submenu && submenu.classList.contains('submenu')) {
                        submenu.classList.toggle('show');
                    }
                }
            });
        });

        // Set active menu item
        this.setActiveMenuItem();
    },

    setActiveMenuItem: function() {
        const currentPath = window.location.pathname;
        const menuItems = document.querySelectorAll('.menu-item');
        
        menuItems.forEach(item => {
            const link = item.getAttribute('href') || item.querySelector('a')?.getAttribute('href');
            if (link && currentPath.includes(link)) {
                item.classList.add('active');
                
                // Open parent submenu if exists
                const parentSubmenu = item.closest('.submenu');
                if (parentSubmenu) {
                    parentSubmenu.classList.add('show');
                    const parentItem = parentSubmenu.previousElementSibling;
                    if (parentItem) {
                        parentItem.classList.add('open');
                    }
                }
            }
        });
    },

    // ============================================
    // HEADER FUNCTIONS
    // ============================================
    initHeader: function() {
        // User dropdown
        const userDropdown = document.querySelector('.user-dropdown');
        const userInfo = document.querySelector('.user-info');
        
        if (userInfo) {
            userInfo.addEventListener('click', function(e) {
                e.stopPropagation();
                userDropdown.classList.toggle('show');
            });
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function(e) {
            if (userDropdown && !userDropdown.contains(e.target)) {
                userDropdown.classList.remove('show');
            }
        });

        // Notification click
        const notificationIcon = document.querySelector('.header-icon.notification');
        if (notificationIcon) {
            notificationIcon.addEventListener('click', function() {
                ITIRRAdmin.showNotifications();
            });
        }
    },

    // ============================================
    // UTILITY FUNCTIONS
    // ============================================
    
    // Show success message
    showSuccess: function(message, title = 'Success') {
        Swal.fire({
            icon: 'success',
            title: title,
            text: message,
            confirmButtonColor: '#4A2C5B',
            confirmButtonText: 'OK'
        });
    },

    // Show error message
    showError: function(message, title = 'Error') {
        Swal.fire({
            icon: 'error',
            title: title,
            text: message,
            confirmButtonColor: '#4A2C5B',
            confirmButtonText: 'OK'
        });
    },

    // Show warning message
    showWarning: function(message, title = 'Warning') {
        Swal.fire({
            icon: 'warning',
            title: title,
            text: message,
            confirmButtonColor: '#4A2C5B',
            confirmButtonText: 'OK'
        });
    },

    // Show info message
    showInfo: function(message, title = 'Information') {
        Swal.fire({
            icon: 'info',
            title: title,
            text: message,
            confirmButtonColor: '#4A2C5B',
            confirmButtonText: 'OK'
        });
    },

    // Confirmation dialog
    confirm: function(message, title = 'Are you sure?', callback) {
        Swal.fire({
            title: title,
            text: message,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#4A2C5B',
            cancelButtonColor: '#6c757d',
            confirmButtonText: 'Yes, proceed!',
            cancelButtonText: 'Cancel'
        }).then((result) => {
            if (result.isConfirmed && callback) {
                callback();
            }
        });
    },

    // Loading overlay
    showLoading: function(message = 'Loading...') {
        Swal.fire({
            title: message,
            allowOutsideClick: false,
            allowEscapeKey: false,
            didOpen: () => {
                Swal.showLoading();
            }
        });
    },

    hideLoading: function() {
        Swal.close();
    },

    // Toast notification
    showToast: function(message, type = 'success') {
        const Toast = Swal.mixin({
            toast: true,
            position: 'top-end',
            showConfirmButton: false,
            timer: 3000,
            timerProgressBar: true,
            didOpen: (toast) => {
                toast.addEventListener('mouseenter', Swal.stopTimer);
                toast.addEventListener('mouseleave', Swal.resumeTimer);
            }
        });

        Toast.fire({
            icon: type,
            title: message
        });
    },

    // ============================================
    // FORM FUNCTIONS
    // ============================================
    initFormValidation: function() {
        const forms = document.querySelectorAll('form[data-validate="true"]');
        
        forms.forEach(form => {
            form.addEventListener('submit', function(e) {
                if (!form.checkValidity()) {
                    e.preventDefault();
                    e.stopPropagation();
                }
                form.classList.add('was-validated');
            });
        });
    },

    // Clear form
    clearForm: function(formId) {
        const form = document.getElementById(formId);
        if (form) {
            form.reset();
            form.classList.remove('was-validated');
            
            // Clear validation messages
            const invalidFeedbacks = form.querySelectorAll('.invalid-feedback');
            invalidFeedbacks.forEach(feedback => {
                feedback.style.display = 'none';
            });
        }
    },

    // Populate form with data
    populateForm: function(formId, data) {
        const form = document.getElementById(formId);
        if (!form) return;

        Object.keys(data).forEach(key => {
            const input = form.querySelector(`[name="${key}"]`);
            if (input) {
                if (input.type === 'checkbox') {
                    input.checked = data[key];
                } else if (input.type === 'radio') {
                    const radio = form.querySelector(`[name="${key}"][value="${data[key]}"]`);
                    if (radio) radio.checked = true;
                } else {
                    input.value = data[key];
                }
            }
        });
    },

    // ============================================
    // TABLE FUNCTIONS
    // ============================================
    
    // Delete row confirmation
    deleteRow: function(id, entityName, deleteUrl, callback) {
        this.confirm(
            `Are you sure you want to delete this ${entityName}? This action cannot be undone.`,
            'Delete Confirmation',
            function() {
                ITIRRAdmin.showLoading('Deleting...');
                
                fetch(deleteUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value
                    },
                    body: JSON.stringify({ id: id })
                })
                .then(response => response.json())
                .then(data => {
                    ITIRRAdmin.hideLoading();
                    if (data.success) {
                        ITIRRAdmin.showSuccess(data.message || `${entityName} deleted successfully`);
                        if (callback) callback();
                    } else {
                        ITIRRAdmin.showError(data.message || 'Failed to delete');
                    }
                })
                .catch(error => {
                    ITIRRAdmin.hideLoading();
                    ITIRRAdmin.showError('An error occurred while deleting');
                    console.error('Delete error:', error);
                });
            }
        );
    },

    // ============================================
    // DATE & TIME FUNCTIONS
    // ============================================
    formatDate: function(dateString) {
        const date = new Date(dateString);
        const day = String(date.getDate()).padStart(2, '0');
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const year = date.getFullYear();
        return `${day}/${month}/${year}`;
    },

    formatDateTime: function(dateString) {
        const date = new Date(dateString);
        const dateFormatted = this.formatDate(dateString);
        const hours = String(date.getHours()).padStart(2, '0');
        const minutes = String(date.getMinutes()).padStart(2, '0');
        return `${dateFormatted} ${hours}:${minutes}`;
    },

    // ============================================
    // AJAX FUNCTIONS
    // ============================================
    ajax: function(url, method = 'GET', data = null, successCallback, errorCallback) {
        const options = {
            method: method,
            headers: {
                'Content-Type': 'application/json',
                'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value
            }
        };

        if (data && (method === 'POST' || method === 'PUT')) {
            options.body = JSON.stringify(data);
        }

        fetch(url, options)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                if (successCallback) successCallback(data);
            })
            .catch(error => {
                console.error('AJAX Error:', error);
                if (errorCallback) {
                    errorCallback(error);
                } else {
                    ITIRRAdmin.showError('An error occurred. Please try again.');
                }
            });
    },

    // ============================================
    // MISC FUNCTIONS
    // ============================================
    initTooltips: function() {
        const tooltips = document.querySelectorAll('[data-bs-toggle="tooltip"]');
        tooltips.forEach(el => {
            new bootstrap.Tooltip(el);
        });
    },

    // Format currency
    formatCurrency: function(amount, currency = 'GBP') {
        return new Intl.NumberFormat('en-GB', {
            style: 'currency',
            currency: currency
        }).format(amount);
    },

    // Debounce function for search
    debounce: function(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    },

    // Show notifications dropdown
    showNotifications: function() {
        // This will be implemented when notification system is ready
        ITIRRAdmin.showInfo('No new notifications', 'Notifications');
    }
};

// Show loading overlay
ITIRRAdmin.showLoading = function (message) {
    const overlay = document.getElementById('loadingOverlay');
    if (overlay) {
        const text = overlay.querySelector('.loading-text');
        if (text) text.textContent = message || 'Please wait...';
        overlay.style.display = 'flex';
    }
};

// Hide loading overlay
ITIRRAdmin.hideLoading = function () {
    const overlay = document.getElementById('loadingOverlay');
    if (overlay) {
        overlay.style.display = 'none';
    }
};

// Set active menu item based on current URL
ITIRRAdmin.setActiveMenu = function () {
    const currentPath = window.location.pathname.toLowerCase();
    const menuLinks = document.querySelectorAll('.sidebar-menu a');

    menuLinks.forEach(link => {
        const linkPath = link.getAttribute('href')?.toLowerCase() || '';

        // Remove active class from all
        link.classList.remove('active');

        // Check if current path matches
        if (currentPath === linkPath ||
            (linkPath !== '/' && linkPath.length > 1 && currentPath.startsWith(linkPath))) {
            link.classList.add('active');

            // Expand parent submenu if inside submenu
            const parentSubmenu = link.closest('.submenu');
            if (parentSubmenu) {
                parentSubmenu.classList.add('show');
                const parentLink = parentSubmenu.previousElementSibling;
                if (parentLink) parentLink.classList.add('active');
            }
        }
    });
};

// Initialize on DOM ready
document.addEventListener('DOMContentLoaded', function() {
    ITIRRAdmin.init();
});

// Make available globally
window.ITIRRAdmin = ITIRRAdmin;